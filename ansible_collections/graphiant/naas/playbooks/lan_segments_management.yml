---
# LAN Segments Management Playbook
# =================================
#
# This playbook demonstrates how to manage global LAN segments using
# the graphiant_global_config module.
#
# Features:
# - Create/configure global LAN segments (idempotent - skips existing)
# - Delete/deconfigure global LAN segments (skips segments with references)
#
# Usage (controlled via tags):
#   # Configure LAN segments - use --tags configure
#   ansible-playbook playbooks/lan_segments_management.yml \
#     --tags configure \
#     -e "graphiant_host=https://your-portal.graphiant.com" \
#     -e "graphiant_username=your-username" \
#     -e "graphiant_password=your-password"
#
#   # Deconfigure LAN segments - use --tags deconfigure
#   ansible-playbook playbooks/lan_segments_management.yml \
#     --tags deconfigure \
#     -e "graphiant_host=https://your-portal.graphiant.com" \
#     -e "graphiant_username=your-username" \
#     -e "graphiant_password=your-password"
#
#   # Run both configure and deconfigure (full cycle)
#   ansible-playbook playbooks/lan_segments_management.yml \
#     --tags configure,deconfigure \
#     -e "graphiant_host=https://your-portal.graphiant.com"
#
# Available tags:
#   - configure: Create LAN segments (idempotent)
#   - deconfigure: Delete LAN segments
#   - info: Display operation info only
#

- name: LAN Segments Management
  hosts: localhost
  gather_facts: false
  vars:
    # Default configuration file (can be overridden with -e)
    config_file: "sample_global_lan_segments.yaml"

    # Use YAML anchors to avoid repetition
    graphiant_client_params: &graphiant_client_params
      host: "{{ graphiant_host | default(lookup('env', 'GRAPHIANT_HOST')) }}"
      username: "{{ graphiant_username | default(lookup('env', 'GRAPHIANT_USERNAME')) }}"
      password: "{{ graphiant_password | default(lookup('env', 'GRAPHIANT_PASSWORD')) }}"
      # host: "{{ graphiant_host | default(lookup('ini', 'url file=/absolute/path/credentials.ini section=host')) }}"
      # username: "{{ graphiant_username | default(lookup('ini', 'username file=/absolute/path/credentials.ini section=credentials')) }}"
      # password: "{{ graphiant_password | default(lookup('ini', 'password file=/absolute/path/credentials.ini section=credentials')) }}"

  tasks:
    - name: Display operation info
      ansible.builtin.debug:
        msg: |
          LAN Segments Management
          =======================
          Config File: {{ config_file }}
          Portal: {{ graphiant_host | default(lookup('env', 'GRAPHIANT_HOST')) }}
      tags: ['always', 'info']

    - name: Configure Global LAN Segments
      graphiant.naas.graphiant_global_config:
        <<: *graphiant_client_params
        config_file: "{{ config_file }}"
        operation: "configure_lan_segments"
        detailed_logs: true
        state: present
      register: configure_result
      tags: ['configure']

    - name: Display Configuration Results
      ansible.builtin.debug:
        msg: "{{ configure_result.msg }}"
      when: configure_result is defined and configure_result.msg is defined
      tags: ['configure']

    - name: Deconfigure Global LAN Segments
      graphiant.naas.graphiant_global_config:
        <<: *graphiant_client_params
        config_file: "{{ config_file }}"
        operation: "deconfigure_lan_segments"
        detailed_logs: true
        state: absent
      register: deconfigure_result
      tags: ['deconfigure']

    - name: Display Deconfiguration Results
      ansible.builtin.debug:
        msg: "{{ deconfigure_result.msg }}"
      when: deconfigure_result is defined and deconfigure_result.msg is defined
      tags: ['deconfigure']
