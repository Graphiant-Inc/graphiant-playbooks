---
- name: Manage Graphiant Static Routes Configuration
  hosts: localhost
  gather_facts: false
  vars:
    # graphiant_host: "https://api.graphiant.com"
    # graphiant_username: "{{ vault_graphiant_username }}"
    # graphiant_password: "{{ vault_graphiant_password }}"

    graphiant_client_params: &graphiant_client_params
      host: "{{ graphiant_host | default(lookup('env', 'GRAPHIANT_HOST')) }}"
      username: "{{ graphiant_username | default(lookup('env', 'GRAPHIANT_USERNAME')) }}"
      password: "{{ graphiant_password | default(lookup('env', 'GRAPHIANT_PASSWORD')) }}"

  tasks:
    - name: Show validated payload (dry-run)
      graphiant.naas.graphiant_static_routes:
        <<: *graphiant_client_params
        operation: show_validated_payload
        static_routes_config_file: "sample_static_route.yaml"
        detailed_logs: true
      register: validate_result
      tags: ['validate']

    - name: Display validated payload
      ansible.builtin.debug:
        msg: "{{ validate_result.validated_payload }}"
      when: validate_result is defined and validate_result.validated_payload is defined
      tags: ['validate']

    - name: Configure static routes
      graphiant.naas.graphiant_static_routes:
        <<: *graphiant_client_params
        operation: configure
        static_routes_config_file: "sample_static_route.yaml"
        detailed_logs: true
        state: present
      register: configure_result
      tags: ['configure']

    - name: Display configure result message (includes detailed logs)
      ansible.builtin.debug:
        msg:
          - "{{ configure_result.msg }}"
          - "configured_devices={{ configure_result.configured_devices | default([]) }}"
          - "skipped_devices={{ configure_result.skipped_devices | default([]) }}"
      when: configure_result is defined and configure_result.msg is defined
      tags: ['configure']

    - name: Deconfigure static routes (deletes only routes listed in YAML)
      graphiant.naas.graphiant_static_routes:
        <<: *graphiant_client_params
        operation: deconfigure
        static_routes_config_file: "sample_static_route.yaml"
        detailed_logs: true
        state: absent
      register: deconfigure_result
      tags: ['deconfigure']

    - name: Display deconfigure result message (includes detailed logs)
      ansible.builtin.debug:
        msg:
          - "{{ deconfigure_result.msg }}"
          - "configured_devices={{ deconfigure_result.configured_devices | default([]) }}"
          - "skipped_devices={{ deconfigure_result.skipped_devices | default([]) }}"
      when: deconfigure_result is defined and deconfigure_result.msg is defined
      tags: ['deconfigure']
