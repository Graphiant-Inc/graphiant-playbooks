---
# Data Exchange Query Service Health Playbook
# This playbook demonstrates how to use the graphiant_data_exchange_info module
# to query Data Exchange service health monitoring information.

- name: Data Exchange Query Service Health
  hosts: localhost
  gather_facts: false
  vars:
    # graphiant_host: "https://api.graphiant.com"
    # graphiant_username: "{{ vault_graphiant_username }}"
    # graphiant_password: "{{ vault_graphiant_password }}"

    # Service name to query health for
    de_service_name: "de-service-1"

    # Use YAML anchors to avoid repetition
    graphiant_client_params: &graphiant_client_params
      host: "{{ graphiant_host | default(lookup('env', 'GRAPHIANT_HOST')) }}"
      username: "{{ graphiant_username | default(lookup('env', 'GRAPHIANT_USERNAME')) }}"
      password: "{{ graphiant_password | default(lookup('env', 'GRAPHIANT_PASSWORD')) }}"
      # host: "{{ graphiant_host | default(lookup('ini', 'url file=/absolute/path/credentials.ini section=host')) }}"
      # username: "{{ graphiant_username | default(lookup('ini', 'username file=/absolute/path/credentials.ini section=credentials')) }}"
      # password: "{{ graphiant_password | default(lookup('ini', 'password file=/absolute/path/credentials.ini section=credentials')) }}"

  tasks:
    - name: Get service health
      graphiant.naas.graphiant_data_exchange_info:
        <<: *graphiant_client_params
        query: service_health
        service_name: "{{ de_service_name }}"
        is_provider: true
        detailed_logs: true
      register: service_health_result

    - name: Display service health
      ansible.builtin.debug:
        msg: "{{ service_health_result.msg }}"
